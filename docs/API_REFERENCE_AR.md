# توثيق واجهة برمجة التطبيقات (API)

يوفّر تطبيق ضغط ملفات PDF واجهة REST ثابتة يمكن دمجها بسهولة مع أي نظام خارجي. يوضّح هذا الدليل كيفية استدعاء نقطة النهاية، والحقول المتاحة، والاستجابات المحتملة، بالإضافة إلى معلومات الضبط والأمن.

## نظرة عامة

- **نقطة النهاية الأساسية:** `POST /compress`
- **صيغة الطلب:** `multipart/form-data`
- **نوع الاستجابة الافتراضي:** ملف PDF مضغوط (`application/pdf`)
- **المصادقة:** غير مطلوبة (يفضّل وضع طبقة حماية خارجية في بيئات الإنتاج)
- **معدّل الطلبات الافتراضي:** `10 طلبات في الدقيقة` لكل عنوان IP (قابل للتعديل عبر المتغيّر `COMPRESS_RATE_LIMIT`)

## الحقول المقبولة في الطلب

| الحقل | النوع | إجباري؟ | الوصف |
| --- | --- | --- | --- |
| `file` | ملف (PDF) | نعم | ملف PDF المراد ضغطه. تُرفض الملفات غير الـ PDF أو التي تتجاوز 20 ميغابايت. |
| `compression_level` | سلسلة نصية | لا (القيمة الافتراضية `medium`) | تحدّد إعداد ضغط Ghostscript. القيم المدعومة: `low` (`/printer`)، `medium` (`/ebook`)، `high` (`/screen`). |
| `preserve_images` | منطقية (مثلاً `on`، `true`, `1`) | لا | عند تفعيلها تُعطَّل خيارات خفض جودة الصور للحفاظ على الدقّة البصرية. |

> **ملاحظة:** يمكن تمرير القيمة `preserve_images` كحقل `checkbox` في النماذج HTML أو كسلسلة نصية في أي عميل HTTP.

## الاستجابات المتوقعة

### نجاح (200)
- يسترجع الخادم الملف المضغوط مباشرة مع ترويسة `Content-Disposition` لضبط اسم الملف على `<الاسم-الأصلي>-compressed.pdf`.
- يتم حذف الملفات المؤقتة (المرفوعة والمضغوطة) فور إرسال الاستجابة.

### أخطاء شائعة

| الرمز | السبب | نموذج استجابة JSON |
| --- | --- | --- |
| 400 | عدم تمرير ملف، أو ملف غير PDF، أو قيمة غير صحيحة لـ `compression_level` | `{ "message": "No PDF file was provided." }` |
| 413 | تجاوز حد الحجم الأقصى (20 ميغابايت) | `{ "message": "The uploaded file exceeds the 20 MiB limit." }` |
| 429 | تجاوز الحد المسموح للطلبات | `{ "message": "Too many requests, please try again later." }` |
| 500 | فشل داخلي (مثل فشل Ghostscript) | `{ "message": "Ghostscript failed while compressing the file." }` |
| 503 | لم يتم العثور على Ghostscript على الخادم | `{ "message": "Ghostscript is not available on the server. Please install it and ensure it can be executed." }` |

## مثال باستخدام `curl`

```bash
curl -X POST "http://<HOST>:<PORT>/compress" \
  -F "file=@/path/to/input.pdf" \
  -F "compression_level=medium" \
  -F "preserve_images=on" \
  -o compressed.pdf
```

- استبدل `<HOST>` و `<PORT>` ببيانات الخادم.
- أزل السطر الخاص بـ `preserve_images` إذا لم تكن بحاجة للحفاظ على الصور.

## إعدادات قابلة للتخصيص

| المتغيّر | الوصف |
| --- | --- |
| `COMPRESS_RATE_LIMIT` | يغيّر الحد الأقصى لعدد الطلبات (صيغة مثل `20 per minute` أو `100 per hour`). |
| `RATELIMIT_STORAGE_URI` | يحدّد مخزن بيانات المعدّل (افتراضيًا ذاكرة مؤقتة؛ يُنصح باستخدام Redis في الإنتاج). |
| `GHOSTSCRIPT_COMMAND` | مسار تنفيذ Ghostscript عند عدم تواجده في متغير `PATH`. |
| `MAX_CONTENT_LENGTH` | حد الحجم الأقصى للملفات (افتراضيًا 20 ميغابايت). |

## أفضل ممارسات الأمن والنشر

- ضع التطبيق خلف وكيـل عكسي (مثل Nginx) مع تفعيل HTTPS.
- استخدم طبقة مصادقة إضافية أو قوائم IP بيضاء إذا تم توفير الخدمة لطرف ثالث.
- تأكد من مراقبة السجلات والأخطاء (يمكن دمج حلول مثل Sentry أو Elastic Stack).
- فعّل التخزين المؤقت والـ CDN عند مشاركة الخدمة على نطاق واسع لتقليل الحمل.

## اختبار واجهة الـ API

1. شغّل الخادم محليًا:
   ```bash
   flask --app app run --debug
   ```
2. أرسل طلب الاختبار الموضّح أعلاه.
3. تحقّق من أن الاستجابة ملف PDF صالح وأن رسائل الأخطاء تظهر بصيغة JSON عند الحالات الفاشلة.

> لتشغيل اختبارات PyTest (تشمل سيناريوهات واجهة الـ API):
> ```bash
> pytest --cov --cov-report=term-missing
> ```

بهذا تكون واجهة الـ API جاهزة للاستخدام من أي عميل خارجي (خدمة، تطبيق موبايل، أو نظام إدارة مستندات).
