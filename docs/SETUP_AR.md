# دليل إعداد وتشغيل مشروع PDFCompress

يشرح هذا الدليل جميع الخطوات اللازمة لتجهيز بيئة العمل، وتنصيب المتطلبات، وإعداد خادم التطبيق ليعمل بصورة صحيحة على الأنظمة الشائعة (لينكس، macOS، وويندوز). تم تصميمه ليكون مرجعًا متكاملًا لأي شخص يريد تشغيل المشروع لأول مرة أو نقله إلى بيئة جديدة.

## 1. نظرة عامة على مكوّنات المشروع

- **الواجهة الخلفية:** تطبيق Flask بلغة Python.
- **أداة الضغط:** Ghostscript عبر سطر الأوامر.
- **الواجهة الأمامية:** HTML/CSS/JavaScript (ضمن القالب `templates/index.html`).
- **الدلائل المهمة:**
  - `uploads/` لحفظ الملفات المرفوعة مؤقتًا.
  - `compressed/` لحفظ النسخ المضغوطة مؤقتًا.
  - يتم حذف الملفات من كلا الدليلين بعد الانتهاء من كل طلب لضمان الأمان.

## 2. المتطلبات الأولية

1. **Python 3.10 أو أحدث** مع أداة `pip`.
2. **Git** (اختياري ولكن مفيد لاستنساخ المستودع وتحديثه).
3. **Ghostscript** مثبت ومتوفر ضمن متغير النظام `PATH` أو يتم تحديد موقعه يدويًا.
4. صلاحيات لإنشاء بيئة افتراضية وأدلة جديدة داخل المشروع.

> **ملاحظة أمنية:** لا تقم أبدًا بتشغيل التطبيق بصلاحيات مرتفعة (مثل `root`) في بيئات الإنتاج. استخدم حسابًا مخصصًا محدود الصلاحيات.

## 3. استنساخ المستودع

```bash
git clone https://github.com/<your-org>/PDFCompress.git
cd PDFCompress
```

أو يمكن تنزيل الملف المضغوط للمشروع وفك ضغطه ثم الانتقال إلى المجلد الجذري.

## 4. تثبيت Python والاعتماديات

### 4.1 إنشاء وتفعيل البيئة الافتراضية

#### على أنظمة Linux/macOS
```bash
python3 -m venv .venv
source .venv/bin/activate
```

#### على نظام Windows (PowerShell)
```powershell
py -3 -m venv .venv
.\.venv\Scripts\Activate.ps1
```

> في حال ظهور رسالة تمنع تشغيل السكربت على PowerShell، استخدم `Set-ExecutionPolicy -Scope CurrentUser RemoteSigned` مرة واحدة ثم أعد المحاولة.

### 4.2 تثبيت الاعتماديات الأساسية

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### 4.3 تثبيت أدوات التطوير والاختبارات (اختياري للمطورين)

```bash
pip install -r requirements-dev.txt
```

## 5. تثبيت وإعداد Ghostscript

Ghostscript هو المحرك المسؤول عن ضغط ملفات PDF. يجب تثبيته قبل تشغيل التطبيق.

### 5.1 أنظمة Linux (Debian/Ubuntu)
```bash
sudo apt update
sudo apt install ghostscript
```

### 5.2 أنظمة Linux (Fedora/CentOS/RHEL)
```bash
sudo dnf install ghostscript
```

### 5.3 macOS (عبر Homebrew)
```bash
brew update
brew install ghostscript
```

### 5.4 Windows

1. حمّل المثبّت من صفحة الإصدارات: <https://ghostscript.com/releases/gsdnld.html>.
2. شغّل المثبّت واتبع التعليمات الافتراضية.
3. تأكد من تفعيل خيار **"Add to PATH"** أثناء التثبيت أو أضف مسار التثبيت يدويًا إلى متغير النظام `PATH`.

### 5.5 التحقق من نجاح التثبيت

بعد تثبيت Ghostscript، شغّل الأمر التالي داخل الطرفية المفعَّلة بالبيئة الافتراضية:

```bash
gs --version
```

يفترض أن يظهر رقم الإصدار (مثلاً `10.02.1`). على Windows قد يكون اسم التنفيذ `gswin64c` أو `gswin32c`. التطبيق يحاول اكتشاف الأسماء الثلاثة تلقائيًا (`gs`, `gswin64c`, `gswin32c`).

### 5.6 تخصيص مسار Ghostscript

إذا لم يكن التنفيذ متوفرًا ضمن `PATH`، حدّد متغير البيئة `GHOSTSCRIPT_COMMAND` إلى المسار الكامل للتنفيذ:

#### Linux/macOS
```bash
export GHOSTSCRIPT_COMMAND="/opt/ghostscript/bin/gs"
```

#### Windows (PowerShell)
```powershell
$env:GHOSTSCRIPT_COMMAND = "C:\\Program Files\\gs\\gs10.02.1\\bin\\gswin64c.exe"
```

ضع المتغير في ملف التهيئة الدائم (`~/.bashrc`, `~/.zshrc`, أو "Environment Variables" في Windows) لضمان توفره في كل جلسة.

## 6. تهيئة متغيرات البيئة الخاصة بالتطبيق

أنشئ ملفًا باسم `.env` في جذر المشروع لتحديد الإعدادات المخصّصة. يمكن استخدام المثال التالي:

```env
FLASK_ENV=development
FLASK_DEBUG=1
SECRET_KEY=change-me
MAX_CONTENT_LENGTH=20971520  # 20 MiB
COMPRESS_RATE_LIMIT=10 per minute
RATELIMIT_STORAGE_URI=memory://
GHOSTSCRIPT_COMMAND=gs
```

> **هام:** استبدل القيمة `change-me` بمفتاح سري حقيقي في البيئات الفعلية، ولا تشارك الملف في نظام التحكم بالإصدارات إذا كان يحتوي على أسرار.

## 7. تهيئة الأدلة المطلوبة

- التطبيق ينشئ `uploads/` و`compressed/` تلقائيًا عند التشغيل، ولكن يمكن إنشاؤهما يدويًا بصلاحيات محدودة:

```bash
mkdir -p uploads compressed
chmod 700 uploads compressed  # على أنظمة Unix لتقييد الوصول
```

## 8. تشغيل التطبيق محليًا

بعد تفعيل البيئة الافتراضية وتثبيت الاعتماديات:

```bash
flask --app app run --debug
```

سيعمل الخادم على العنوان `http://127.0.0.1:5000/`. افتح المتصفح وتوجه للعنوان لرفع ملفات PDF وتجربة الضغط.

## 9. تشغيل الاختبارات والتحقق من الجودة

لضمان سلامة البيئة، نفّذ الأوامر التالية (خاصة قبل تقديم أي تغييرات):

```bash
black --check .
isort --check-only --profile black .
flake8
mypy app.py tests
pytest --cov --cov-report=term-missing
pip-audit
```

> يمكن استخدام `pre-commit` (إن تم إعداده) لأتمتة هذه العمليات.

## 10. نشر التطبيق على خادم إنتاج

1. استخدم خادم WSGI مثل **Gunicorn** أو **uWSGI** خلف عاكس عكسي (Nginx أو Apache).
2. أنشئ مستخدم نظام مخصص للتطبيق وحدد صلاحيات المجلدات (`uploads/`, `compressed/`, `/tmp`).
3. فعِّل HTTPS عبر مزود الشهادات (مثل Let’s Encrypt).
4. استخدم نظام مراقبة (مثل Sentry أو Prometheus) لتتبع الأخطاء والأداء.
5. فعِّل النسخ الاحتياطي الدوري وراقب المساحة المتاحة للأقراص.
6. راقب استهلاك الموارد وفعِّل آليات التنبيه عند ارتفاع معدل الأخطاء أو زمن الاستجابة.

## 11. استكشاف الأخطاء الشائعة

| المشكلة | الأعراض | الحل |
|---------|---------|------|
| Ghostscript غير متوفر | ظهور رسالة `FileNotFoundError` أو `No such file or directory: 'gs'` | تحقق من تثبيت Ghostscript وضبط `PATH` أو المتغير `GHOSTSCRIPT_COMMAND`. |
| فشل في إنشاء الملفات المؤقتة | رسالة "Permission denied" عند الحفظ داخل `uploads/` أو `compressed/` | تأكد من صلاحيات الكتابة للمجلدات وأن التطبيق لا يعمل بصلاحيات محدودة جدًا. |
| تعارض في المنفذ 5000 | الخادم لا يبدأ ويظهر الخطأ "Address already in use" | أوقف التطبيق الآخر أو شغّل الأمر `flask --app app run --debug --port 5001`. |
| بطء شديد في الضغط | وقت الاستجابة طويل عند الملفات الكبيرة | اختر إعداد ضغط أقل (مثل `medium` بدل `high`) أو زِد موارد الخادم. |

## 12. صيانة دورية

- حدِّث الاعتماديات بشكل دوري باستخدام `pip install -r requirements.txt --upgrade` في بيئة منفصلة للاختبار أولًا.
- راجع سجلات الدخول (`logs/` إن تم إعدادها) للتأكد من عدم وجود أخطاء متكررة.
- نظِّف المجلدات المؤقتة بانتظام في حالة تم إيقاف التطبيق قبل حذف الملفات تلقائيًا.
- نفِّذ اختبارات التكامل بعد كل تحديث للتأكد من استمرار عمل عملية الضغط.

بهذه الخطوات يصبح المشروع جاهزًا للتشغيل في بيئة تطوير أو إنتاج مع ضمان تجهيز جميع المتطلبات اللازمة، بما فيها Ghostscript.
